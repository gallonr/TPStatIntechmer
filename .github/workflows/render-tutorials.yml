name: Render Tutoriels R Markdown et Quarto

on:
  push:
    branches:
      - main
    paths:
      - 'Rmarkdown_Quarto/**'
      - '.github/workflows/render-tutorials.yml'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  render-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3.2'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libcurl4-openssl-dev \
            libssl-dev \
            libxml2-dev \
            libfontconfig1-dev \
            libharfbuzz-dev \
            libfribidi-dev \
            libfreetype6-dev \
            libpng-dev \
            libtiff5-dev \
            libjpeg-dev

      - name: Install R packages
        run: |
          Rscript -e 'install.packages(c("rmarkdown", "knitr", "ggplot2", "dplyr", "corrplot", "car", "lmtest", "ggpubr", "readxl"))'

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Create output directory
        run: |
          mkdir -p docs/tutoriels

      - name: Render R Markdown tutorial
        run: |
          cd Rmarkdown_Quarto
          Rscript -e 'rmarkdown::render("Tutoriel_RMarkdown.Rmd", output_file = "../docs/tutoriels/Tutoriel_RMarkdown.html")'

      - name: Render Quarto tutorial
        run: |
          cd Rmarkdown_Quarto
          quarto render Tutoriel_Quarto.qmd --output-dir ../docs/tutoriels

      - name: Create index page
        run: |
          cat > docs/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="fr">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Tutoriels R Markdown et Quarto</title>
            <style>
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                max-width: 900px;
                margin: 50px auto;
                padding: 20px;
                line-height: 1.6;
                background: #f5f5f5;
              }
              .container {
                background: white;
                padding: 40px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
              }
              h1 {
                color: #2c3e50;
                border-bottom: 3px solid #3498db;
                padding-bottom: 10px;
              }
              h2 {
                color: #34495e;
                margin-top: 30px;
              }
              .tutorial-card {
                background: #f8f9fa;
                border-left: 4px solid #3498db;
                padding: 20px;
                margin: 20px 0;
                border-radius: 4px;
              }
              .tutorial-card h3 {
                margin-top: 0;
                color: #2c3e50;
              }
              .tutorial-card a {
                display: inline-block;
                background: #3498db;
                color: white;
                padding: 10px 20px;
                text-decoration: none;
                border-radius: 4px;
                margin-top: 10px;
                transition: background 0.3s;
              }
              .tutorial-card a:hover {
                background: #2980b9;
              }
              .features {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 15px;
                margin: 20px 0;
              }
              .feature {
                background: #ecf0f1;
                padding: 15px;
                border-radius: 4px;
              }
              .emoji {
                font-size: 24px;
                margin-right: 10px;
              }
              footer {
                text-align: center;
                margin-top: 40px;
                padding-top: 20px;
                border-top: 1px solid #ddd;
                color: #7f8c8d;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>üìö Tutoriels R Markdown et Quarto</h1>
              <p>
                Bienvenue ! Ces tutoriels vous guideront dans la cr√©ation de rapports scientifiques
                reproductibles en aquaculture et halieutique.
              </p>

              <h2>üéì Tutoriels disponibles</h2>

              <div class="tutorial-card">
                <h3><span class="emoji">üìò</span> Tutoriel R Markdown</h3>
                <p>
                  Guide complet sur R Markdown : mise en forme, formules math√©matiques,
                  chunks de code, et cr√©ation de rapports professionnels.
                </p>
                <p><strong>Exemples :</strong> Croissance de la daurade, analyse du bar europ√©en</p>
                <a href="tutoriels/Tutoriel_RMarkdown.html">Ouvrir le tutoriel R Markdown ‚Üí</a>
              </div>

              <div class="tutorial-card">
                <h3><span class="emoji">üìó</span> Tutoriel Quarto</h3>
                <p>
                  Guide complet sur Quarto (successeur de R Markdown) : toutes les fonctionnalit√©s
                  de R Markdown + callouts, r√©f√©rences crois√©es, et bien plus.
                </p>
                <p><strong>Exemples :</strong> √âvaluation de stocks, captures de thon rouge</p>
                <a href="tutoriels/Tutoriel_Quarto.html">Ouvrir le tutoriel Quarto ‚Üí</a>
              </div>

              <h2>‚ú® Ce que vous apprendrez</h2>
              <div class="features">
                <div class="feature">
                  <strong>üìù Mise en forme</strong><br>
                  Titres, listes, tableaux, texte format√©
                </div>
                <div class="feature">
                  <strong>üßÆ Formules</strong><br>
                  SGR, FCR, von Bertalanffy, etc.
                </div>
                <div class="feature">
                  <strong>üíª Code R</strong><br>
                  Chunks, options, graphiques
                </div>
                <div class="feature">
                  <strong>üìä Graphiques</strong><br>
                  ggplot2, l√©gendes, r√©f√©rences
                </div>
                <div class="feature">
                  <strong>üìÑ Export</strong><br>
                  HTML, PDF, Word
                </div>
                <div class="feature">
                  <strong>üîÑ Reproductibilit√©</strong><br>
                  Code + r√©sultats + texte
                </div>
              </div>

              <h2>üöÄ Pour commencer</h2>
              <ol>
                <li>Installer <strong>R</strong> et <strong>RStudio</strong></li>
                <li>Pour R Markdown : installer le package <code>rmarkdown</code></li>
                <li>Pour Quarto : installer <a href="https://quarto.org" target="_blank">Quarto CLI</a></li>
                <li>Suivre les tutoriels ci-dessus</li>
              </ol>

              <footer>
                <p>
                  üìß Questions ou suggestions ? Contactez l'enseignant<br>
                  üîó <a href="https://github.com/gallonr" target="_blank">Voir le code source sur GitHub</a>
                </p>
                <p style="font-size: 0.9em; margin-top: 20px;">
                  G√©n√©r√© automatiquement avec GitHub Actions ‚Ä¢ Derni√®re mise √† jour : <span id="date"></span>
                </p>
              </footer>
            </div>
            <script>
              document.getElementById('date').textContent = new Date().toLocaleDateString('fr-FR');
            </script>
          </body>
          </html>
          EOF

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'docs'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
